## Monitoramento com Prometheus

Monitoramento com Prometheus no Google Cloud

​**1\. Introdução ao Prometheus**

Prometheus é uma ferramenta de monitoramento de código aberto projetada para coletar, armazenar e consultar métricas de sistemas e aplicativos. Ele se integra facilmente com Kubernetes e outros sistemas em nuvem, tornando-se uma escolha popular para monitoramento e alerta em ambientes de produção.

- **Características Principais do Prometheus:**
	- Modelagem de Dados Baseada em Time Series: Prometheus coleta dados como séries temporais, ou seja, conjuntos de dados indexados pelo tempo.
	- Sistema de Consulta e Alerta: Usa a PromQL, uma linguagem de consulta poderosa para analisar e visualizar métricas.
	- Monitoramento de Contêineres: Excelente integração com Kubernetes para monitoramento de Pods, Nodes e serviços.
	- Autossuficiente: Armazena os dados localmente e executa scraping periodicamente para obter métricas de endpoints HTTP.

Em um cluster Kubernetes rodando no Google Cloud, o Prometheus pode ser usado para monitorar o uso de CPU, memória, tráfego de rede e outras métricas críticas de performance dos Pods.

#### 2\. Implantação de um Aplicativo de Exemplo

Para demonstrar como Prometheus pode ser usado para monitorar uma aplicação no Google Kubernetes Engine (GKE), você pode começar implantando uma aplicação de exemplo, como o “Hello World”.

**Passos para Implantar um Aplicativo de Exemplo:**

1\. Criar um Cluster GKE:

- No Google Cloud Console, crie um cluster Kubernetes usando o Google Kubernetes Engine.

| gcloud container clusters create my-cluster --zone us-central1-a --num-nodes=3 |
| --- |

**2\. Escrever o Manifesto de Implantação:**

Crie um arquivo YAML que defina o Pod e o serviço para o aplicativo de exemplo:

| apiVersion: apps/v1​  kind: Deployment​  metadata:​    name: hello-world​  spec:​    replicas: 3​    selector:​      matchLabels:​        app: hello-world​    template:​      metadata:​        labels:​          app: hello-world​      spec:​        containers:​        - name: hello-world​          image: [gcr.io/google-samples/hello-app:1.0](http://gcr.io/google-samples/hello-app:1.0)​          ports:​          - containerPort: 8080​ |
| --- |

**3\. Implantar no Cluster:**

- Use kubectl para aplicar o arquivo e implantar a aplicação:

| kubectl apply -f hello-world.yaml |
| --- |

Esse exemplo simples demonstra como você pode implantar uma aplicação que será monitorada pelo Prometheus para capturar métricas de uso e desempenho em tempo real.

#### 3\. Configuração de um Recurso PodMonitoring

No Kubernetes, o Prometheus pode ser configurado para monitorar Pods de forma eficiente. O recurso PodMonitoring permite configurar facilmente o Prometheus para monitorar aplicações rodando em Pods.

**Passos para Configurar PodMonitoring:**

**1\. Instalar o Prometheus Operator:**

O Prometheus Operator facilita a configuração de Prometheus no Kubernetes. Para instalar:

| kubectl apply -f [https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/main/bundle.yaml](https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/main/bundle.yaml) |
| --- |

**2\. Definir o Recurso PodMonitoring:**

Crie um arquivo YAML para o recurso PodMonitoring:  

| apiVersion: [monitoring.googleapis.com/v1](http://monitoring.googleapis.com/v1)​  kind: PodMonitoring​  metadata:​    name: hello-monitoring​  spec:​    selector:​      matchLabels:​        app: hello-world​    endpoints:​    - port: 8080​      interval: 30s​ |
| --- |

**3\. Aplicar o Arquivo de Configuração:**

- Use kubectl para aplicar a configuração de PodMonitoring:

| kubectl apply -f pod-monitoring.yaml |
| --- |

Ao configurar o PodMonitoring, você garante que o Prometheus coleta dados de desempenho detalhados do Pod “hello-world”, como latência e uso de recursos.

#### 4\. Download e Execução do Prometheus

Para configurar o Prometheus manualmente no Google Cloud, você pode fazer o download e executá-lo localmente ou no GKE.

**Passos para Download e Execução do Prometheus:**

**1\. Download do Prometheus:**

Baixe a última versão do Prometheus diretamente do site oficial:  

| wget [https://github.com/prometheus/prometheus/releases/download/v2.30.3/prometheus-2.30.3.linux-amd64.tar.gz](https://github.com/prometheus/prometheus/releases/download/v2.30.3/prometheus-2.30.3.linux-amd64.tar.gz)​  tar xvfz prometheus-2.30.3.linux-amd64.tar.gz​  cd prometheus-2.30.3.linux-amd64​ |
| --- |

**2. Executar o Prometheus:**

- Inicie o Prometheus usando o arquivo de configuração padrão:

| ./prometheus --config.file=prometheus.yml |
| --- |

**3\. Acessar o Dashboard:**

Após iniciar o Prometheus, você pode acessar o dashboard em:

| [http://localhost:9090](http://localhost:9090/) |
| --- |

Depois de instalar e rodar o Prometheus, você pode começar a monitorar suas métricas diretamente no dashboard, onde também pode usar consultas PromQL para gerar gráficos e relatórios de desempenho.

#### 4\. Download e Execução do Node Exporter

Node Exporter é um componente do Prometheus que coleta métricas de hardware e sistema operacional, como uso de CPU, memória, e espaço em disco.

**Passos para Download e Execução do Node Exporter:**

**1\. Download do Node Exporter:**

Faça o download da última versão do Node Exporter:  

| wget​  ​[https://github.com/prometheus/node\_exporter/releases/download/v1.2.2/node\_exporter-1.2.2.linux-amd64.tar.gz](https://github.com/prometheus/node_exporter/releases/download/v1.2.2/node_exporter-1.2.2.linux-amd64.tar.gz)​  tar xvfz node\_exporter-1.2.2.linux-amd64.tar.gz​  cd node\_exporter-1.2.2.linux-amd64​ |
| --- |

**2\. Executar o Node Exporter:**

- Inicie o Node Exporter:  
	./node\_exporter

**3\. Configurar Prometheus para Coletar Métricas:**

No arquivo de configuração prometheus.yml, adicione o Node Exporter como um alvo:  

| scrape\_configs:​  \- job\_name: ‘node\_exporter’​    static\_configs:​    - targets: \[‘localhost:9100’\] |
| --- |

**4\. Reiniciar o Prometheus:**

- Após atualizar o arquivo de configuração, reinicie o Prometheus para começar a coletar métricas do Node Exporter.

Ao integrar o Node Exporter com o Prometheus, você pode obter insights detalhados sobre o desempenho dos nodes físicos ou virtuais no Google Cloud, monitorando o uso de CPU, disco e rede.

Ao integrar o Node Exporter com o Prometheus, você pode obter insights detalhados sobre o desempenho dos nodes físicos ou virtuais no Google Cloud, monitorando o uso de CPU, disco e rede.

  

**Conteúdo Bônus  
**  
**Título**: Observabilidade do aplicativo com o Prometheus no GKE  
**Plataforma**: Cloud.Google  
**Descrição**: Neste tutorial, mostramos como configurar sondagens de atividade para microsserviços de aplicativos implantados no Google Kubernetes Engine (GKE) usando o Prometheus de código aberto.

  

**Referências Bibliográficas**  
  
BASSO, D. E. **Administração de Redes de Computadores**. Contentus, 2020.  
KUROSE, J. F.; ROSS, K. W. **Redes de Computadores e a Internet: Uma Abordagem Top-Down**. 8. ed. Pearson, 2021.  
MARINHO, A. L.; CRUZ, J. L. da. (Orgs.). **Desenvolvimento de Aplicações para Internet**. 2. ed. Pearson, 2020.  
PUGA, S.; RISSETTI, G. **Lógica de Programação e Estruturas de Dados, com Aplicações em Java**. 3. ed. Pearson, 2016.  
ROHLING, L. J. **Segurança de Redes de Computadores**. Contentus, 2020.  
SILVA, C. F. da. **Projeto Estruturado e Gerência de Redes**. Contentus, 2020.  
TANENBAUM, A. S.; FEAMSTER, N.; WETHERALL, D. J. **Redes de Computadores**. 6. ed. Pearson, 2021.  
TOCCI, R. J.; WIDMER, N. S.; MOSS, G. L. **Sistemas Digitais: Princípios e Aplicações**. 12. ed. Pearson, 2018.